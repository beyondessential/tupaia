import { createPatch } from 'diff';
import * as fs from 'node:fs';
import { resolve } from 'node:path';
import * as TJS from 'typescript-json-schema';

// @ts-ignore
import config from './config/schemas/config.json';

console.log('üé∞ Generating schemas...');
const tic = performance.now();

const failOnChanges = process.argv[2] === '--failOnChanges';

const settings: TJS.PartialArgs = {
  ref: false,
  required: true,
  ignoreErrors: true,
  noExtraProps: true,
};

function getTsFiles(dir: string): string[] {
  const dirContents = fs.readdirSync(dir);
  const files = dirContents.flatMap(dirItem => {
    const res = resolve(dir, dirItem);
    return fs.statSync(res).isDirectory() ? getTsFiles(res) : res;
  });

  return files.filter(fileName => fileName.endsWith('.ts'));
}

const HEADER = `/*
 * This file was generated by a tool.
 * Rerun generate:schemas to regenerate this file.
 */
`;

const rootDir = 'src/types';
const filesToBuildSchemasFor = getTsFiles(rootDir);

const { filename, typesPath } = config as any;

const program = TJS.getProgramFromFiles([resolve(typesPath)]);
const schemas = TJS.generateSchema(program, '*', settings, filesToBuildSchemasFor);

if (schemas?.definitions) {
  let fileContents = HEADER;

  const definitions = Object.entries(schemas.definitions || {});
  for (const [typeName, schema] of definitions) {
    if (typeof schema === 'boolean') continue;
    fileContents += `export const ${typeName}Schema = ${JSON.stringify(schema, null, '\t')}\n`;
  }
  console.log(`‚ÑπÔ∏è Generated ${definitions.length} schema definitions`);

  if (failOnChanges) {
    const currentFileContents = fs.readFileSync(filename, { encoding: 'utf8' });
    if (currentFileContents !== fileContents) {
      const patch = createPatch(filename, currentFileContents, fileContents);
      console.log(
        `${process.env.CI ? '::error::' : '‚ùå '}There are changes in the types which are not reflected in the JSON schema. Run \`yarn workspace @tupaia/types run generate\` to fix.`,
      );
      console.log(patch);
      process.exit(1);
    }
  }

  fs.writeFileSync(filename, fileContents);
  console.log(`üíæ Wrote ${filename}`);

  const duration = performance.now() - tic;
  console.log(`‚úÖ Done in ${Math.round(duration)} ms`);
}
