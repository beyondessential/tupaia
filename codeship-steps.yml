- type: parallel
  name: validate-and-test
  steps:
    - type: parallel
      name: validate
      steps:
        - name: validate branch name
          service: meditrak-server-validation
          command: './packages/devops/scripts/ci/validateBranchName.sh'
        - type: parallel
          name: validate all code
          services:
            - meditrak-server-validation
            - web-config-server-validation
          steps:
            - name: validate package code
              command: './packages/devops/scripts/ci/validateCode.sh'
    - type: serial
      name: test
      steps:
        - type: parallel # they're in containers, so even though they generally use one db, they're sandboxed
          name: test-all
          steps:
            - name: test-meditrak-server
              service: meditrak-server-testing
              command: './packages/devops/scripts/ci/testBackend.sh'
            - name: test-web-config-server
              service: web-config-server-testing
              command: './packages/devops/scripts/ci/testBackend.sh'
            - name: test-database
              service: database-testing
              command: './packages/devops/scripts/ci/testBackend.sh'
            - name: test-data-api
              service: data-api-testing
              command: './packages/devops/scripts/ci/testBackend.sh'
            - name: test-internal-dependencies
              service: internal-dependency-testing
              command: './packages/devops/scripts/ci/testInternalDependencies.sh'

- type: serial
  name: pull latest into ec2
  service: deployment
  steps:
    - name: reinstate SSH Private Key File
      command: /bin/bash -c "echo -e $PRIVATE_SSH_KEY >> /root/.ssh/id_rsa"
    - name: chmod id_rsa
      command: chmod 600 /root/.ssh/id_rsa
    - name: pull latest and install dependencies
      command: './packages/devops/scripts/ci/pullLatest.sh'

- type: parallel
  name: deploy-all
  service: deployment
  steps:
    - type: serial
      name: deploy-backends
      steps:
        - type: parallel
          name: restart-backends
          steps:
            - name: deploy-web-config-server
              command: './packages/devops/scripts/ci/deployBackend.sh web-config-server'
            - name: deploy-meditrak-server
              command: './packages/devops/scripts/ci/deployBackend.sh meditrak-server'
        # run migrations immediately after backend deployment has finished so there is minimal time for code/db mismatch
        - name: run db migrations
          command: './packages/devops/scripts/ci/runMigrations.sh'
    # build front ends in serial because they consume a lot of resources, and can crash deployment if run in parallel
    - type: serial
      name: deploy-frontends
      steps:
        - name: deploy-web-frontend
          command: './packages/devops/scripts/ci/deployFrontend.sh web-frontend'
        - name: deploy-admin-panel
          command: './packages/devops/scripts/ci/deployFrontend.sh admin-panel'
