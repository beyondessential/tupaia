- type: parallel
  name: validate-and-test
  exclude: -e2e$
  steps:
    - type: parallel
      name: validate
      service: validation
      steps:
        - name: validate branch name
          command: './packages/devops/scripts/ci/validateBranchName.sh'
        - name: validate tests
          command: './packages/devops/scripts/ci/validateTests.sh'
    - type: serial
      name: test
      service: testing
      steps:
        - type: parallel
          name: test-batch-1 # they're in sandboxed containers, but share a db which can't handle all at once
          steps:
            - name: test-admin-panel-server
              command: './packages/devops/scripts/ci/testBackend.sh admin-panel-server'
            - name: test-lesmis-server
              command: './packages/devops/scripts/ci/testBackend.sh lesmis-server'
            - name: test-meditrak-server
              command: './packages/devops/scripts/ci/testBackend.sh meditrak-server'
            - name: test-web-config-server
              command: './packages/devops/scripts/ci/testBackend.sh web-config-server'
            - name: test-psss-server
              command: './packages/devops/scripts/ci/testBackend.sh psss-server'
            - name: test-report-server
              command: './packages/devops/scripts/ci/testBackend.sh report-server'
            - name: test-entity-server
              command: './packages/devops/scripts/ci/testBackend.sh entity-server'
        - type: parallel
          name: test-batch-2
          steps:
            - name: test-database
              command: './packages/devops/scripts/ci/testBackend.sh database'
            - name: test-data-api
              command: './packages/devops/scripts/ci/testBackend.sh data-api'
            - name: test-auth
              command: './packages/devops/scripts/ci/testBackend.sh auth'
            - name: test-indicators
              command: './packages/devops/scripts/ci/testBackend.sh indicators'
            - name: test-internal-dependencies
              command: './packages/devops/scripts/ci/testInternalDependencies.sh'
            - name: test-web-frontend
              command: './packages/devops/scripts/ci/testFrontend.sh web-frontend'

- name: check-for-deployment
  service: deployment
  command: './packages/devops/scripts/ci/checkDeploymentExists.sh'

- type: serial
  name: pull latest into ec2
  service: deployment
  exclude: -e2e$
  steps:
    - name: reinstate SSH Private Key File
      # Need to use 'sed' here to remove open/close quotes, see: https://github.com/docker/compose/issues/2854
      # Note: this issue is fixed in more recent versions of docker-compose (1.26+) but codeship still uses an older version
      command: /bin/bash -c "echo -e $PRIVATE_SSH_KEY | sed -e 's/^"//' -e 's/"$//' >> /root/.ssh/id_rsa"
    - name: chmod id_rsa
      command: chmod 600 /root/.ssh/id_rsa
    - name: pull latest and install dependencies
      command: './packages/devops/scripts/ci/pullLatest.sh'

- type: serial
  name: build-and-deploy-backends
  exclude: -e2e$
  steps:
    - type: serial
      name: web-config-server
      steps:
        - name: build-web-config-server
          service: builder
          command: './packages/devops/scripts/ci/buildBackend.sh web-config-server'
        - name: deploy-web-config-server
          service: deployment
          command: './packages/devops/scripts/ci/deployBackend.sh web-config-server'
    - type: serial
      name: lesmis-server
      steps:
        - name: build-lesmis-server
          service: builder
          command: './packages/devops/scripts/ci/buildBackend.sh lesmis-server'
        - name: deploy-lesmis-server
          service: deployment
          command: './packages/devops/scripts/ci/deployBackend.sh lesmis-server'
    - type: serial
      name: meditrak-server
      steps:
        - name: build-meditrak-server
          service: builder
          command: './packages/devops/scripts/ci/buildBackend.sh meditrak-server'
        - name: deploy-meditrak-server
          service: deployment
          command: './packages/devops/scripts/ci/deployBackend.sh meditrak-server'
    - type: serial
      name: psss-server
      steps:
        - name: build-psss-server
          service: builder
          command: './packages/devops/scripts/ci/buildBackend.sh psss-server'
        - name: deploy-psss-server
          service: deployment
          command: './packages/devops/scripts/ci/deployBackend.sh psss-server'
    - type: serial
      name: admin-panel-server
      steps:
        - name: build-admin-panel-server
          service: builder
          command: './packages/devops/scripts/ci/buildBackend.sh admin-panel-server'
        - name: deploy-admin-panel-server
          service: deployment
          command: './packages/devops/scripts/ci/deployBackend.sh admin-panel-server'
    - type: serial
      name: report-server
      steps:
        - name: build-report-server
          service: builder
          command: './packages/devops/scripts/ci/buildBackend.sh report-server'
        - name: deploy-report-server
          service: deployment
          command: './packages/devops/scripts/ci/deployBackend.sh report-server'
    - type: serial
      name: entity-server
      steps:
        - name: build-entity-server
          service: builder
          command: './packages/devops/scripts/ci/buildBackend.sh entity-server'
        - name: deploy-entity-server
          service: deployment
          command: './packages/devops/scripts/ci/deployBackend.sh entity-server'

# run migrations immediately after backend deployment has finished so there is minimal time for code/db mismatch
- name: run db migrations
  service: deployment
  exclude: -e2e$
  command: './packages/devops/scripts/ci/runMigrations.sh'

- type: serial
  name: build-and-deploy-frontends
  exclude: -e2e$
  steps:
    - type: serial
      name: web-frontend
      steps:
        - name: build-web-frontend
          service: builder
          command: './packages/devops/scripts/ci/buildFrontend.sh web-frontend'
        - name: deploy-web-frontend
          service: deployment
          command: './packages/devops/scripts/ci/deployFrontend.sh web-frontend'
    - type: serial
      name: admin-panel
      steps:
        - name: build-admin-panel
          service: builder
          command: './packages/devops/scripts/ci/buildFrontend.sh admin-panel'
        - name: deploy-admin-panel
          service: deployment
          command: './packages/devops/scripts/ci/deployFrontend.sh admin-panel'
    - type: serial
      name: psss
      steps:
        - name: build-psss
          service: builder
          command: './packages/devops/scripts/ci/buildFrontend.sh psss'
        - name: deploy-psss
          service: deployment
          command: './packages/devops/scripts/ci/deployFrontend.sh psss'
    - type: serial
      name: lesmis
      steps:
        - name: build-lesmis
          service: builder
          command: './packages/devops/scripts/ci/buildFrontend.sh lesmis'
        - name: deploy-lesmis
          service: deployment
          command: './packages/devops/scripts/ci/deployFrontend.sh lesmis'

- type: parallel
  name: e2e-test
  service: e2e
  tag: -e2e$
  steps:
    - name: e2e-test-web-frontend
      command: './packages/devops/scripts/ci/testE2e.sh web-frontend'
