- name: Validate and test
  type: serial
  exclude: -e2e$
  steps:
    - name: Validate 1
      type: parallel
      service: validation
      steps:
        - name: Validate branch name
          command: './packages/devops/scripts/ci/validateBranchName.sh'
        - name: Validate new migrations
          command: './packages/devops/scripts/ci/validateNewMigrations.sh'
        - name: Validate tests
          command: './packages/devops/scripts/ci/validateTests.sh'
    - name: Test
      type: serial
      service: testing
      steps:
        - name: Setup test dbs
          command: './packages/devops/scripts/ci/setupTestDbs.sh'
        - name: Validate types
          command: './packages/devops/scripts/ci/validateTypesAndSchemaInSync.sh'
        - name: Test batch 1
          type: parallel
          steps:
            - name: Test admin-panel-server
              command: 'yarn workspace @tupaia/admin-panel-server test'
            - name: Test central-server
              command: 'yarn workspace @tupaia/central-server test'
            - name: Test data-table-server
              command: 'yarn workspace @tupaia/data-table-server test'
            - name: Test entity-server
              command: 'yarn workspace @tupaia/entity-server test'
            - name: Test lesmis-server
              command: 'yarn workspace @tupaia/lesmis-server test'
            - name: Test meditrak-app-server
              command: 'yarn workspace @tupaia/meditrak-app-server test'
            - name: Test psss-server
              command: 'yarn workspace @tupaia/psss-server test'
            - name: Test report-server
              command: 'yarn workspace @tupaia/report-server test'
            - name: Test web-config-server
              command: 'yarn workspace @tupaia/web-config-server test'
        - name: Test batch 2
          type: parallel
          steps:
            - name: Test auth
              command: 'yarn workspace @tupaia/auth test'
            - name: Test data-api
              command: 'yarn workspace @tupaia/data-api test'
            - name: Test data-lake-api
              command: 'yarn workspace @tupaia/data-lake-api test'
            - name: Test database
              command: 'yarn workspace @tupaia/database test'
            - name: Test indicators
              command: 'yarn workspace @tupaia/indicators test'
            - name: Test internal-dependencies
              command: './packages/devops/scripts/ci/testInternalDependencies.sh'
            - name: Test web-frontend
              command: 'yarn workspace @tupaia/web-frontend test'

- name: Deploy changes
  service: deployment
  command: './triggerRedeploy.sh'

- name: E2E test
  type: parallel
  service: e2e
  tag: -e2e$
  steps:
    - name: E2E test
      command: './packages/devops/scripts/ci/testE2e.sh'
